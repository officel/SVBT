# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

tasks:
  default:
    cmds:
      # - task --list --sort alphanumeric -t {{.TASKFILE}}
      - task --list --sort none -t {{.TASKFILE}}
      - gh issue list
    silent: true

  work:
    desc: how to works
    aliases:
      - work
    silent: true
    cmds:
      - |-
        cat <<- 'EOF'
          $ cd ../SVBT/
          $ gr                 # git fetch --all --prune && git checkout origin/HEAD
          $ t                  # task
          $ t d
          $ t test

          # VS Code の実行とデバッグで動作確認をする
          # 問題なければコミットしてPRしてマージ

          $ t pr               # 変更履歴を作成
          $ code CHANGELOG.md  # フォーマットがいまいちなので開いて適用
          $ gpr chore/0.0.10   # 変更履歴をコミットしてPRしてマージ

          # タグを打ってプッシュすると自動でリリースされる
          $ g tag v0.0.10
          $ g push origin v0.0.10
        EOF

  watch:
    desc: for watching file changes
    aliases:
      - w
    cmds:
      - npm run watch

  dev:
    desc: for development
    aliases:
      - d
    cmds:
      - npm run dev

  test:
    desc: for running tests
    aliases:
      - test
    cmds:
      - npm run test

  package:
    desc: for production
    aliases:
      - p
    cmds:
      - npm run package

  vscode:vsix:
    desc: create a .vsix file
    aliases:
      - vsix
    cmds:
      - npx vsce package

  vscode:prepublish:
    desc: run tasks before publishing
    aliases:
      - vpp
    cmds:
      - npm run package

  vscode:publish:
    desc: publish for Marketplace
    summary: |-
      マケプレで公開する。
      package.json のバージョンを更新してから実行すること。
    aliases:
      - vp
    cmds:
      - npx vsce publish

  pre-release:
    desc: run tasks before releasing
    aliases:
      - pr
    vars:
      INPUT_VERSION: '{{ default "patch" .V }}'
      # ex: task pr V=1.0.0
      # デフォルトは patch なので、 task pr とするだけでよい
      VERSION:
        sh: |
          npm version {{.INPUT_VERSION}} --no-git-tag-version | tail -n 1
      # package.json と package-lock.json の version が更新される
    cmds:
      - echo {{.INPUT_VERSION}}
      - echo {{.VERSION}}
      - npm ci
      - npm run changelog
